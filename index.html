
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HEXAGON - Firebase</title>
    
    <style>
        /* Reset e Base */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background-color: #f9fafb; 
            color: #1f2937; 
            line-height: 1.6; 
        }
        
        /* Utilitários */
        .bg-gray-50 { background-color: #f9fafb; }
        .bg-white { background-color: #ffffff; }
        .bg-blue-600 { background-color: #2563eb; }
        .bg-green-500 { background-color: #10b981; }
        .text-gray-800 { color: #1f2937; }
        .text-gray-700 { color: #374151; }
        .text-gray-600 { color: #4b5563; }
        .text-blue-600 { color: #2563eb; }
        .text-white { color: #ffffff; }
        .font-bold { font-weight: 700; }
        .font-semibold { font-weight: 600; }
        .font-medium { font-weight: 500; }
        .text-xl { font-size: 1.25rem; }
        .text-4xl { font-size: 2.25rem; }
        .p-3 { padding: 0.75rem; }
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        .p-8 { padding: 2rem; }
        .pt-8 { padding-top: 2rem; }
        .pb-6 { padding-bottom: 1.5rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .border { border-width: 1px; }
        .border-gray-300 { border-color: #d1d5db; }
        .w-full { width: 100%; }
        .max-w-6xl { max-width: 72rem; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }
        .gap-6 { gap: 1.5rem; }
        .text-center { text-align: center; }
        .grid { display: grid; }
        .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .shadow-md { 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); 
        }
        .min-h-screen { min-height: 100vh; }
        .cursor-pointer { cursor: pointer; }
        .transition-all { transition: all 0.3s ease; }
        
        @media (min-width: 768px) {
            .md\\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        }
        
        /* Componentes */
        .btn-primary {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(37, 99, 235, 0.2);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .product-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }
        
        .product-card.selected {
            border-color: #2563eb;
            background-color: #f8fafc;
            box-shadow: 0 4px 6px rgba(37, 99, 235, 0.1);
        }
        
        .qty-controls {
            display: none;
            margin-top: 0.75rem;
            padding: 0.75rem;
            background-color: #f9fafb;
            border-radius: 0.375rem;
            border: 1px solid #e5e7eb;
        }
        
        .qty-controls.show {
            display: block;
        }
        
        /* Layout Responsivo para campos Qtd/Lote */
        .qty-row {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        
        .qty-row:last-child {
            margin-bottom: 0;
        }
        
        .qty-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* Desktop: Layout horizontal */
        @media (min-width: 640px) {
            .qty-row {
                flex-direction: row;
                align-items: center;
                gap: 0.75rem;
            }
        }
        
        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            transition: border-color 0.2s;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .completion-screen {
            display: none;
            text-align: center;
            padding: 3rem;
        }
        
        .completion-screen.show {
            display: block;
        }
        
        .main-content.hide {
            display: none;
        }
        
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #2563eb;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 0.5rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Estilos responsivos para campos de quantidade e lote */
        .qty-select {
            width: 80px;
            height: 44px;
            padding: 8px 6px;
            border: 2px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 16px;
            font-weight: 500;
            background-color: white;
            transition: border-color 0.2s;
        }

        .qty-select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .lot-input {
            flex: 1;
            min-width: 100px;
            height: 44px;
            padding: 8px 12px;
            border: 2px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 16px;
            background-color: white;
            transition: border-color 0.2s;
        }

        .lot-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Labels responsivos */
        .qty-label {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            min-width: 35px;
        }

        /* Mobile: Labels mais compactos */
        @media (max-width: 639px) {
            .qty-label {
                font-size: 13px;
                min-width: 30px;
            }
            
            .qty-select {
                width: 70px;
            }
        }

        /* Botões + e - melhorados */
        .add-btn {
            background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
            color: white;
            border: none;
            border-radius: 0.375rem;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            align-self: flex-start;
        }

        .add-btn:hover {
            background: linear-gradient(135deg, #1e40af 0%, #1d4ed8 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(29, 78, 216, 0.3);
        }

        .remove-btn {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
            border: none;
            border-radius: 0.375rem;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            align-self: flex-start;
        }

        .remove-btn:hover {
            background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(220, 38, 38, 0.3);
        }

        /* Mobile: Botão + centralizado */
        @media (max-width: 639px) {
            .add-btn {
                align-self: center;
                margin-top: 0.5rem;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    
    <!-- HEXAGON Title -->
    <div class="pt-8 pb-6 text-center">
        <h1 class="text-4xl font-bold text-gray-800 mb-2">HEXAGON</h1>
        <h2 class="text-xl font-semibold text-gray-700 mb-2">Registro de Materiais Ortopédicos</h2>
    </div>

    <!-- Main Content -->
    <div class="main-content max-w-6xl mx-auto px-4">
        
        <!-- Patient Information -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-6">
            <h3 class="font-semibold mb-4 text-gray-800">Informações do Paciente</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block font-medium text-gray-700 mb-2">Usuário *</label>
                    <input type="text" id="userField" placeholder="Nome do usuário" 
                           class="input-field" oninput="capitalizeInput(this)">
                </div>
                
                <div>
                    <label class="block font-medium text-gray-700 mb-2">Hospital *</label>
                    <input type="text" id="hospitalSelect" placeholder="Nome do hospital" 
                           class="input-field" oninput="capitalizeInput(this)">
                </div>
                
                <div>
                    <label class="block font-medium text-gray-700 mb-2">Paciente</label>
                    <input type="text" id="patientName" placeholder="Nome do paciente" 
                           class="input-field" oninput="capitalizeInput(this)">
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label class="block font-medium text-gray-700 mb-2">N° Prontuário</label>
                    <input type="text" id="recordNumber" placeholder="Número do prontuário" 
                           class="input-field">
                </div>
                
                <div>
                    <label class="block font-medium text-gray-700 mb-2">Data Cirurgia</label>
                    <input type="date" id="surgeryDate" class="input-field">
                </div>
                
                <div>
                    <label class="block font-medium text-gray-700 mb-2">Outras Informações</label>
                    <textarea id="otherInfo" placeholder="Informações adicionais" rows="2" 
                              class="input-field"></textarea>
                </div>
            </div>
        </div>

        <!-- Product Selection -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-6">
            <div class="mb-4">
                <label class="block font-medium text-gray-700 mb-2">Selecionar Subgrupo:</label>
                <select id="documentType" onchange="filterProducts()" class="input-field">
                    <option value="">Carregando subgrupos...</option>
                </select>
            </div>

            <div id="productsContainer">
                <div class="text-center p-8 text-gray-600">
                    Selecione um subgrupo para visualizar os produtos
                </div>
            </div>
        </div>

        <!-- Filter Buttons -->
        <div class="grid grid-cols-2 gap-3 mb-6">
            <button onclick="showSelectedOnly()" class="btn-success">
                Filtrar Selecionados
            </button>
            <button onclick="showAllProducts()" class="btn-primary">
                Mostrar Todos
            </button>
        </div>

        <!-- Materiais Diversos -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-6">
            <label class="block font-medium text-gray-700 mb-2">Materiais Diversos:</label>
            <textarea id="materiaisDiversos" placeholder="Digite materiais diversos..." rows="4" 
                      class="input-field"></textarea>
        </div>

        <!-- Send Report Button -->
        <button onclick="sendReport()" class="w-full btn-success p-4 text-xl mb-6">
            Enviar Relatório
        </button>
    </div>

    <!-- Completion Screen -->
    <div class="completion-screen">
        <div class="bg-white p-8 rounded-xl shadow-md mx-auto" style="max-width: 28rem;">
            <div style="font-size: 4rem; color: #10b981; margin-bottom: 1rem;">✓</div>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Relatório Enviado</h2>
            <p class="text-gray-600 mb-6">Relatório enviado com sucesso!</p>
            <button onclick="startNewReport()" class="btn-primary w-full">
                Novo Relatório
            </button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDnJsxMxCLCcpqYCxrO4njbxKMTqoOpmtg",
            authDomain: "app-hexagon-materiais.firebaseapp.com",
            projectId: "app-hexagon-materiais",
            storageBucket: "app-hexagon-materiais.firebasestorage.app",
            messagingSenderId: "810793753497",
            appId: "1:810793753497:web:b5a6a812b18e09bfdd5108"
        };

        // Initialize Firebase
        let app, db;
        
        function initializeFirebase() {
            try {
                console.log('Firebase SDK carregada com sucesso');
                app = firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                console.log('Firebase inicializado:', firebaseConfig.projectId);
                return true;
            } catch (error) {
                console.error('Erro ao inicializar Firebase:', error);
                return false;
            }
        }

        // Initialize on DOM ready
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Hexagon Firebase iniciado');
            
            if (initializeFirebase()) {
                await carregarSubgrupos();
            } else {
                console.error('Falha na inicialização do Firebase');
                document.getElementById('documentType').innerHTML = '<option value="">Erro de conexão Firebase</option>';
            }
        });
        
        // Collections
        const COLLECTIONS = [
            'parafusos_canulados', 'fixadores_externos', 'placas_sem_bloqueio_gr_frag',
            'placas_com_bloqueio_pequ_frag', 'hastes_intram_femur', 'hastes_intram_tibia',
            'hastes_intram_umero', 'micro_placas_com_bloqueio', 'placas_com_bloqueio_gr_frag',
            'placas_sem_bloqueio_pequ_frag', 'placas_volares_com_bloqueio'
        ];
        
        // Global variables
        let currentProducts = [];
        let allSubgroups = new Map();
        
        // Capitalize input
        function capitalizeInput(input) {
            const words = input.value.toLowerCase().split(' ');
            input.value = words.map(word => 
                word.length > 0 ? word.charAt(0).toUpperCase() + word.slice(1) : word
            ).join(' ');
        }
        
        // Load subgroups
        async function carregarSubgrupos() {
            try {
                const select = document.getElementById('documentType');
                select.innerHTML = '<option value="">Carregando...</option>';
                
                const gruposOrganizados = {};
                let totalProcessed = 0;
                
                console.log('Carregando subgrupos...');
                
                for (const collection of COLLECTIONS) {
                    try {
                        console.log(`Buscando subgrupos de: ${collection}`);
                        const snapshot = await db.collection(collection).orderBy('ordem_global').limit(500).get();
                        
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            if (data.grupo && data.subgrupo) {
                                const grupo = data.grupo.trim();
                                const subgrupo = data.subgrupo.trim();
                                
                                if (!gruposOrganizados[grupo]) {
                                    gruposOrganizados[grupo] = new Set();
                                }
                                gruposOrganizados[grupo].add(subgrupo);
                                allSubgroups.set(subgrupo, collection);
                                totalProcessed++;
                            }
                        });
                        
                        console.log(`✓ ${collection}: processados`);
                        
                    } catch (error) {
                        console.warn(`Erro na coleção ${collection}:`, error);
                        if (error.message.includes('index')) {
                            console.warn(`Índice necessário para ${collection}`);
                        }
                    }
                }
                
                // Build dropdown
                select.innerHTML = '<option value="">Selecione um subgrupo</option>';
                
                const sortedGroups = Object.keys(gruposOrganizados).sort();
                
                if (sortedGroups.length === 0) {
                    select.innerHTML = '<option value="">Nenhum subgrupo encontrado</option>';
                    console.warn('Nenhum subgrupo carregado. Verifique os índices do Firebase.');
                    return;
                }
                
                sortedGroups.forEach(grupo => {
                    const headerOption = document.createElement('option');
                    headerOption.value = '';
                    headerOption.textContent = `═══ ${grupo} ═══`;
                    headerOption.disabled = true;
                    headerOption.style.fontWeight = 'bold';
                    headerOption.style.backgroundColor = '#374151';
                    headerOption.style.color = 'white';
                    select.appendChild(headerOption);
                    
                    Array.from(gruposOrganizados[grupo]).sort().forEach(subgrupo => {
                        const option = document.createElement('option');
                        option.value = subgrupo;
                        option.textContent = `  ${subgrupo}`;
                        select.appendChild(option);
                    });
                });
                
                console.log(`✅ Subgrupos carregados: ${allSubgroups.size} encontrados`);
                
            } catch (error) {
                console.error('Erro ao carregar subgrupos:', error);
                document.getElementById('documentType').innerHTML = '<option value="">Erro ao carregar - Verifique índices Firebase</option>';
            }
        }
        
        // Filter products
        async function filterProducts() {
            const subgrupo = document.getElementById('documentType').value;
            const container = document.getElementById('productsContainer');
            
            if (!subgrupo) {
                container.innerHTML = '<div class="text-center p-8 text-gray-600">Selecione um subgrupo</div>';
                return;
            }
            
            container.innerHTML = '<div class="text-center p-8 text-blue-600"><div class="loading-spinner"></div>Buscando produtos...</div>';
            
            try {
                const collection = allSubgroups.get(subgrupo);
                if (!collection) {
                    container.innerHTML = '<div class="text-center p-8 text-red-600">Coleção não encontrada</div>';
                    return;
                }
                
                console.log(`Buscando produtos em: ${collection} para subgrupo: ${subgrupo}`);
                
                const snapshot = await db.collection(collection)
                    .where('subgrupo', '==', subgrupo)
                    .orderBy('ordem_global')
                    .limit(500)
                    .get();
                
                const produtos = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    produtos.push({
                        codigo: data.codigo,
                        nome: data.descricao || data.nome,
                        ordem_global: data.ordem_global
                    });
                });
                
                currentProducts = produtos;
                renderProducts();
                
                console.log(`✓ ${produtos.length} produtos carregados para ${subgrupo}`);
                
            } catch (error) {
                console.error('Erro ao buscar produtos:', error);
                let errorMsg = 'Erro de conexão';
                
                if (error.message.includes('index')) {
                    errorMsg = 'Erro: Índice necessário no Firebase<br><small>Verifique a configuração dos índices</small>';
                } else if (error.message.includes('permission')) {
                    errorMsg = 'Erro: Permissão negada<br><small>Verifique as regras de segurança</small>';
                }
                
                container.innerHTML = `<div class="text-center p-8 text-red-600">${errorMsg}</div>`;
            }
        }
        
        // Render products
        function renderProducts() {
            const container = document.getElementById('productsContainer');
            container.innerHTML = '';
            
            if (currentProducts.length === 0) {
                container.innerHTML = '<div class="text-center p-8 text-gray-600">Nenhum produto encontrado</div>';
                return;
            }
            
            currentProducts.forEach((product, index) => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.innerHTML = `
                    <div class="flex items-start gap-3">
                        <input type="checkbox" onchange="toggleProductSelection(${index})" 
                               class="mt-1 w-5 h-5" id="checkbox-${index}">
                        <div class="flex-1">
                            <div class="font-medium text-gray-900">${product.nome}</div>
                            <div class="text-gray-500 text-sm">Código: ${product.codigo}</div>
                        </div>
                    </div>
                    <div class="qty-controls" id="qty-controls-${index}">
                        <div class="qty-row">
                            <div class="qty-group">
                                <label class="qty-label">Qtd:</label>
                                <select class="qty-select">
                                    <option value="">-</option>
                                    ${Array.from({length: 10}, (_, i) => `<option value="${i+1}">${i+1}</option>`).join('')}
                                </select>
                            </div>
                            <div class="qty-group">
                                <label class="qty-label">Lote:</label>
                                <input type="text" placeholder="Lote" maxlength="15" class="lot-input">
                            </div>
                            <button onclick="addLot(${index})" class="add-btn">+</button>
                        </div>
                        <div id="additional-lots-${index}"></div>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        // Toggle product selection
        function toggleProductSelection(index) {
            const checkbox = document.getElementById(`checkbox-${index}`);
            const controls = document.getElementById(`qty-controls-${index}`);
            const card = checkbox.closest('.product-card');
            
            if (checkbox.checked) {
                controls.classList.add('show');
                card.classList.add('selected');
            } else {
                controls.classList.remove('show');
                card.classList.remove('selected');
                document.getElementById(`additional-lots-${index}`).innerHTML = '';
            }
        }
        
        // Add lot
        function addLot(productIndex) {
            const container = document.getElementById(`additional-lots-${productIndex}`);
            const lotDiv = document.createElement('div');
            lotDiv.className = 'qty-row';
            lotDiv.style.backgroundColor = '#f3f4f6';
            lotDiv.style.padding = '0.5rem';
            lotDiv.style.borderRadius = '0.375rem';
            lotDiv.innerHTML = `
                <div class="qty-group">
                    <label class="qty-label">Qtd:</label>
                    <select class="qty-select">
                        <option value="">-</option>
                        ${Array.from({length: 10}, (_, i) => `<option value="${i+1}">${i+1}</option>`).join('')}
                    </select>
                </div>
                <div class="qty-group">
                    <label class="qty-label">Lote:</label>
                    <input type="text" placeholder="Lote" maxlength="15" class="lot-input">
                </div>
                <button onclick="removeLot(this)" class="remove-btn">-</button>
            `;
            container.appendChild(lotDiv);
        }
        
        // Remove lot
        function removeLot(button) {
            button.closest('.qty-row').remove();
        }
        
        // Show selected only
        function showSelectedOnly() {
            const cards = document.querySelectorAll('.product-card');
            cards.forEach(card => {
                const checkbox = card.querySelector('input[type="checkbox"]');
                if (!checkbox.checked) {
                    card.style.display = 'none';
                }
            });
        }
        
        // Show all products
        function showAllProducts() {
            const cards = document.querySelectorAll('.product-card');
            cards.forEach(card => {
                card.style.display = 'block';
            });
        }
        
        // Format date
        function formatDateBrazilian(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('pt-BR');
        }
        
        // Generate separator line
        function generateSeparator(length = 32) {
            return '='.repeat(length);
        }
        
        // Generate PDF
        function generatePDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Header
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text('REGISTRO DE CONSUMO DE MATERIAIS CONSIGNADOS', 105, 20, { align: 'center' });
                
                let yPos = 35;
                
                // Separator
                doc.setFontSize(10);
                doc.text(generateSeparator(50), 105, yPos, { align: 'center' });
                yPos += 10;
                
                // Patient info
                doc.setFont(undefined, 'normal');
                doc.text(`Usuário: ${document.getElementById('userField').value || ''}`, 20, yPos);
                yPos += 6;
                doc.text(`Hospital: ${document.getElementById('hospitalSelect').value || ''}`, 20, yPos);
                yPos += 6;
                doc.text(`Nome do Paciente: ${document.getElementById('patientName').value || ''}`, 20, yPos);
                yPos += 6;
                doc.text(`Num Prontuario: ${document.getElementById('recordNumber').value || ''}`, 20, yPos);
                yPos += 6;
                doc.text(`Data da Cirurgia: ${formatDateBrazilian(document.getElementById('surgeryDate').value)}`, 20, yPos);
                yPos += 6;
                doc.text(`Outras Informações: ${document.getElementById('otherInfo').value || ''}`, 20, yPos);
                yPos += 10;
                
                // Separator
                doc.text(generateSeparator(50), 105, yPos, { align: 'center' });
                yPos += 10;
                
                // Materials
                const checkboxes = document.querySelectorAll('.product-card input[type="checkbox"]:checked');
                checkboxes.forEach(checkbox => {
                    const index = parseInt(checkbox.id.split('-')[1]);
                    const product = currentProducts[index];
                    
                    const qtyControls = document.getElementById(`qty-controls-${index}`);
                    const allRows = qtyControls.querySelectorAll('.qty-row');
                    
                    allRows.forEach(row => {
                        const qtySelect = row.querySelector('select');
                        const lotInput = row.querySelector('input[type="text"]');
                        
                        if (lotInput && lotInput.value) {
                            doc.text(`Codigo: ${product.codigo}`, 20, yPos);
                            yPos += 5;
                            doc.text(`Produto: ${product.nome}`, 20, yPos);
                            yPos += 5;
                            doc.text(`Lote: ${lotInput.value}`, 20, yPos);
                            yPos += 5;
                            doc.text(`Quantidade: ${qtySelect.value || '1'}`, 20, yPos);
                            yPos += 10;
                            
                            // Separator
                            doc.text(generateSeparator(50), 105, yPos, { align: 'center' });
                            yPos += 10;
                            
                            if (yPos > 260) {
                                doc.addPage();
                                yPos = 20;
                            }
                        }
                    });
                });
                
                // Materiais Diversos
                const diversos = document.getElementById('materiaisDiversos').value;
                if (diversos) {
                    doc.text('Materiais Diversos:', 20, yPos);
                    yPos += 6;
                    doc.text(diversos, 20, yPos);
                    yPos += 10;
                    
                    // Final separator
                    doc.text(generateSeparator(50), 105, yPos, { align: 'center' });
                }
                
                return doc;
                
            } catch (error) {
                console.error('Erro PDF:', error);
                throw error;
            }
        }

        // Send report
        function sendReport() {
            try {
                const userField = document.getElementById('userField').value.trim();
                const hospitalSelect = document.getElementById('hospitalSelect').value.trim();
                
                if (!userField) {
                    alert('Preencha o campo Usuário');
                    return;
                }
                
                if (!hospitalSelect) {
                    alert('Preencha o campo Hospital');
                    return;
                }
                
                // Build message using exact format
                let message = 'REGISTRO DE CONSUMO DE MATERIAIS CONSIGNADOS\n';
                message += generateSeparator() + '\n';
                message += `Usuário: ${userField}\n`;
                message += `Hospital: ${hospitalSelect}\n`;
                message += `Nome do Paciente: ${document.getElementById('patientName').value || ''}\n`;
                message += `Num Prontuario: ${document.getElementById('recordNumber').value || ''}\n`;
                message += `Data da Cirurgia: ${formatDateBrazilian(document.getElementById('surgeryDate').value) || ''}\n`;
                message += `Outras Informações: ${document.getElementById('otherInfo').value || ''}\n`;
                message += generateSeparator() + '\n';
                
                // Materials
                const checkboxes = document.querySelectorAll('.product-card input[type="checkbox"]:checked');
                
                checkboxes.forEach(checkbox => {
                    const index = parseInt(checkbox.id.split('-')[1]);
                    const product = currentProducts[index];
                    
                    const qtyControls = document.getElementById(`qty-controls-${index}`);
                    const allRows = qtyControls.querySelectorAll('.qty-row');
                    
                    allRows.forEach(row => {
                        const qtySelect = row.querySelector('select');
                        const lotInput = row.querySelector('input[type="text"]');
                        
                        if (lotInput && lotInput.value) {
                            message += `Codigo: ${product.codigo}\n`;
                            message += `Produto: ${product.nome}\n`;
                            message += `Lote: ${lotInput.value}\n`;
                            message += `Quantidade: ${qtySelect.value || '1'}\n`;
                            message += generateSeparator() + '\n';
                        }
                    });
                });
                
                // Materiais Diversos
                const diversos = document.getElementById('materiaisDiversos').value;
                if (diversos) {
                    message += 'Materiais Diversos:\n';
                    message += diversos + '\n';
                    message += generateSeparator() + '\n';
                }
                
                // Generate PDF
                try {
                    const pdf = generatePDF();
                    const pdfBlob = pdf.output('blob');
                    const pdfUrl = URL.createObjectURL(pdfBlob);
                    
                    const link = document.createElement('a');
                    link.href = pdfUrl;
                    link.download = `Hexagon_${new Date().toISOString().slice(0,10)}.pdf`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                } catch (pdfError) {
                    console.error('Erro PDF:', pdfError);
                }
                
                // WhatsApp
                const whatsappUrl = `https://wa.me/5519998935452?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
                
                showCompletionScreen();
                
            } catch (error) {
                console.error('Erro ao enviar:', error);
                alert('Erro ao enviar relatório');
            }
        }

        // Show completion screen
        function showCompletionScreen() {
            document.querySelector('.main-content').classList.add('hide');
            document.querySelector('.completion-screen').classList.add('show');
        }

        // Start new report
        function startNewReport() {
            document.getElementById('otherInfo').value = '';
            document.getElementById('materiaisDiversos').value = '';
            document.getElementById('documentType').value = '';
            document.getElementById('productsContainer').innerHTML = 
                '<div class="text-center p-8 text-gray-600">Selecione um subgrupo para visualizar os produtos</div>';
            
            document.querySelector('.main-content').classList.remove('hide');
            document.querySelector('.completion-screen').classList.remove('show');
        }
    </script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"963fd4447f890a86","serverTiming":{"name":{"cfExtPri":true,"cfEdge":true,"cfOrigin":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"version":"2025.7.0","token":"4edd5f8ec12a48cfa682ab8261b80a79"}' crossorigin="anonymous"></script>
</body>
</html>
    <script id="html_badge_script1">
        window.__genspark_remove_badge_link = "https://www.genspark.ai/api/html_badge/" +
            "remove_badge?token=To%2FBnjzloZ3UfQdcSaYfDmMRea%2BBe902N05Y3r3f6WRY4EWV4%2BVBhzABbTuIA%2Bb3dN1fqODwFxzNFjU8263rRTCr1P0BgHlZFup8Gw42LurzE2mgoeR4YseYyh0Rk2fkv7VzUf4SpGKoPKiJ74X0s%2B0%2F1UarpLmG21DmZ5nIvlvTrXLSB5eB6wZWPJquIgRR5a2SUaYw4DPW%2FICwNbdzYBCWx3T0jwnYolmZPpuCXpDroD5E776cHOApT1tsCbi%2FTqw%2BpglkIHlgIPTstn96u8iPkB9hISgY5DGoGt1KyPsU3oPItInK%2F8KbJeDCkLFb9msNi4ewaiHmZxO5TiRb67ojOgXN%2FnkYhXstQiecUTmAnH%2FxASVGp3uPQ0mGUcUCQEUixNczxbE9099qwVHk9%2FUmJmPVzWHV%2BOk8YXiMd4%2FbH3tXTrq7Cw1ofmZnxtnD6jvsGXQiiY4hYpBjFRtaMoJNt2cvxJ7NN8gYoauu9h7GAd6Mwsfk4ngKt1P2w842aFz0dZTcHjopGqpA%2FTF1KB9UkFUNvlqs2pKTaz9uHbQ%3D";
        window.__genspark_locale = "pt-BR";
        window.__genspark_token = "To/BnjzloZ3UfQdcSaYfDmMRea+Be902N05Y3r3f6WRY4EWV4+VBhzABbTuIA+b3dN1fqODwFxzNFjU8263rRTCr1P0BgHlZFup8Gw42LurzE2mgoeR4YseYyh0Rk2fkv7VzUf4SpGKoPKiJ74X0s+0/1UarpLmG21DmZ5nIvlvTrXLSB5eB6wZWPJquIgRR5a2SUaYw4DPW/ICwNbdzYBCWx3T0jwnYolmZPpuCXpDroD5E776cHOApT1tsCbi/Tqw+pglkIHlgIPTstn96u8iPkB9hISgY5DGoGt1KyPsU3oPItInK/8KbJeDCkLFb9msNi4ewaiHmZxO5TiRb67ojOgXN/nkYhXstQiecUTmAnH/xASVGp3uPQ0mGUcUCQEUixNczxbE9099qwVHk9/UmJmPVzWHV+Ok8YXiMd4/bH3tXTrq7Cw1ofmZnxtnD6jvsGXQiiY4hYpBjFRtaMoJNt2cvxJ7NN8gYoauu9h7GAd6Mwsfk4ngKt1P2w842aFz0dZTcHjopGqpA/TF1KB9UkFUNvlqs2pKTaz9uHbQ=";
    </script>
    
    <script id="html_notice_dialog_script" src="https://www.genspark.ai/notice_dialog.js"></script>
    
