
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HEXAGON - Registro de Materiais Consignados</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="HEXAGON">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Bibliotecas externas -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <style>
        /* Reset e Base */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background-color: #f9fafb; 
            color: #1f2937; 
            line-height: 1.6; 
        }
        
        /* Utilit√°rios complementares ao Tailwind */
        .min-h-screen { min-height: 100vh; }
        .cursor-pointer { cursor: pointer; }
        .transition-all { transition: all 0.3s ease; }
        
        /* Componentes */
        .btn-primary {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(37, 99, 235, 0.2);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .product-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }
        
        .product-card.selected {
            border-color: #2563eb;
            background-color: #f8fafc;
            box-shadow: 0 4px 6px rgba(37, 99, 235, 0.1);
        }
        
        .qty-controls {
            display: none;
            margin-top: 0.75rem;
            padding: 0.75rem;
            background-color: #f9fafb;
            border-radius: 0.375rem;
            border: 1px solid #e5e7eb;
        }
        
        .qty-controls.show {
            display: block;
        }
        
        .qty-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            position: relative;
        }
        
        .qty-row:last-child {
            margin-bottom: 0;
        }
        
        .qty-left {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
        }
        
        .qty-buttons {
            display: flex;
            gap: 0.25rem;
        }
        
        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            transition: border-color 0.2s;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .completion-screen {
            display: none;
            text-align: center;
            padding: 3rem;
        }
        
        .completion-screen.show {
            display: block;
        }
        
        .main-content.hide {
            display: none;
        }
        
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #2563eb;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 0.5rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Estilos espec√≠ficos para campos de quantidade e lote - MOBILE OTIMIZADO */
        .qty-select {
            width: 60px;
            height: 40px;
            padding: 6px 4px;
            border: 2px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 14px;
            font-weight: 500;
            background-color: white;
            transition: border-color 0.2s;
        }

        .qty-select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .lot-input {
            width: 80px;
            height: 40px;
            padding: 6px 4px;
            border: 2px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 14px;
            background-color: white;
            transition: border-color 0.2s;
        }

        .lot-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .qty-label {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            min-width: 30px;
        }

        /* Bot√µes + e - melhorados */
        .add-btn {
            background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
            color: white;
            border: none;
            border-radius: 0.375rem;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-btn:hover {
            background: linear-gradient(135deg, #1e40af 0%, #1d4ed8 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(29, 78, 216, 0.3);
        }

        .remove-btn {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
            border: none;
            border-radius: 0.375rem;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-btn:hover {
            background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(220, 38, 38, 0.3);
        }

        /* Pop-up de confirma√ß√£o */
        .confirm-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .confirm-popup.show {
            display: flex;
        }

        .confirm-content {
            background: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            max-width: 400px;
            margin: 1rem;
            text-align: center;
        }

        .confirm-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            justify-content: center;
        }

        .btn-cancel {
            background: #6b7280;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-cancel:hover {
            background: #4b5563;
        }

        /* PWA Install Button */
        .install-button {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 50px;
            padding: 1rem;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
            z-index: 1000;
        }

        .install-button:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
        }
        
        /* Estilo para vers√£o */
        .version-text {
            text-align: center;
            padding: 10px;
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    
    <!-- PWA Install Button -->
    <button id="installButton" class="install-button">
        üì± Instalar App
    </button>

    <!-- HEXAGON Title -->
    <div class="pt-8 pb-6 text-center">
        <h1 class="text-4xl font-bold text-gray-800 mb-2">HEXAGON</h1>
        <h2 class="text-xl font-semibold text-gray-700 mb-2">REGISTRO DE CONSUMO DE MATERIAIS CONSIGNADOS</h2>
    </div>

    <!-- Main Content -->
    <div class="main-content max-w-6xl mx-auto px-4">
        
        <!-- Patient Information -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-6">
            <h3 class="font-semibold mb-4 text-gray-800">Informa√ß√µes do Paciente</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block font-medium text-gray-700 mb-2">Usu√°rio *</label>
                    <input type="text" id="userField" placeholder="Nome do usu√°rio" 
                           class="input-field" oninput="capitalizeInput(this)">
                </div>
                
                <div>
                    <label class="block font-medium text-gray-700 mb-2">Hospital *</label>
                    <input type="text" id="hospitalSelect" placeholder="Nome do hospital" 
                           class="input-field" oninput="capitalizeInput(this)">
                </div>
                
                <div>
                    <label class="block font-medium text-gray-700 mb-2">Paciente</label>
                    <input type="text" id="patientName" placeholder="Nome do paciente" 
                           class="input-field" oninput="capitalizeInput(this)">
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label class="block font-medium text-gray-700 mb-2">N¬∞ Prontu√°rio</label>
                    <input type="text" id="recordNumber" placeholder="N√∫mero do prontu√°rio" 
                           class="input-field">
                </div>
                
                <div>
                    <label class="block font-medium text-gray-700 mb-2">Data Cirurgia *</label>
                    <input type="date" id="surgeryDate" class="input-field">
                </div>
                
                <div>
                    <label class="block font-medium text-gray-700 mb-2">Outras Informa√ß√µes</label>
                    <textarea id="otherInfo" placeholder="Informa√ß√µes adicionais" rows="2" 
                              class="input-field"></textarea>
                </div>
            </div>
        </div>

        <!-- Product Selection -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-6">
            <div class="mb-4">
                <label class="block font-medium text-gray-700 mb-2">Selecionar Subgrupo: *</label>
                <select id="documentType" onchange="filterProducts()" class="input-field">
                    <option value="">Selecione um subgrupo</option>
                    <!-- Subgrupos de demonstra√ß√£o -->
                    <option value="" disabled style="font-weight:bold; background-color:#374151; color:white;">‚ïê‚ïê‚ïê PARAFUSOS CANULADOS ‚ïê‚ïê‚ïê</option>
                    <option value="PARAFUSOS CANUL COMPR HEBBERT">  PARAFUSOS CANUL COMPR HEBBERT</option>
                    <option value="PARAFUSOS CANULADOS 3,5">  PARAFUSOS CANULADOS 3,5</option>
                    <option value="PARAFUSOS CANULADOS 4,5">  PARAFUSOS CANULADOS 4,5</option>
                    <option value="PARAFUSOS CANULADOS 6,5">  PARAFUSOS CANULADOS 6,5</option>
                    <option value="PARAFUSOS CANULADOS 7,0">  PARAFUSOS CANULADOS 7,0</option>
                    <option value="" disabled style="font-weight:bold; background-color:#374151; color:white;">‚ïê‚ïê‚ïê PLACAS ‚ïê‚ïê‚ïê</option>
                    <option value="PLACAS COM BLOQUEIO GR FRAG">  PLACAS COM BLOQUEIO GR FRAG</option>
                    <option value="PLACAS SEM BLOQUEIO GR FRAG">  PLACAS SEM BLOQUEIO GR FRAG</option>
                    <option value="PLACAS COM BLOQUEIO PEQU FRAG">  PLACAS COM BLOQUEIO PEQU FRAG</option>
                    <option value="PLACAS SEM BLOQUEIO PEQU FRAG">  PLACAS SEM BLOQUEIO PEQU FRAG</option>
                    <option value="PLACAS VOLARES COM BLOQUEIO">  PLACAS VOLARES COM BLOQUEIO</option>
                    <option value="MICRO PLACAS COM BLOQUEIO">  MICRO PLACAS COM BLOQUEIO</option>
                    <option value="" disabled style="font-weight:bold; background-color:#374151; color:white;">‚ïê‚ïê‚ïê FIXADORES EXTERNOS ‚ïê‚ïê‚ïê</option>
                    <option value="FIXADOR EXTERNO">  FIXADOR EXTERNO</option>
                    <option value="FIXADOR MINI">  FIXADOR MINI</option>
                    <option value="" disabled style="font-weight:bold; background-color:#374151; color:white;">‚ïê‚ïê‚ïê HASTES INTRAMEDULARES ‚ïê‚ïê‚ïê</option>
                    <option value="HASTES INTRAM FEMUR">  HASTES INTRAM FEMUR</option>
                    <option value="HASTES INTRAM TIBIA">  HASTES INTRAM TIBIA</option>
                    <option value="HASTES INTRAM UMERO">  HASTES INTRAM UMERO</option>
                </select>
            </div>

            <div id="productsContainer">
                <div class="text-center p-8 text-gray-600">
                    Selecione um subgrupo para visualizar os produtos
                </div>
            </div>
        </div>

        <!-- Filter Buttons -->
        <div class="grid grid-cols-2 gap-3 mb-6">
            <button onclick="showSelectedOnly()" class="btn-success">
                Filtrar Selecionados
            </button>
            <button onclick="showAllProducts()" class="btn-primary">
                Mostrar Todos
            </button>
        </div>

        <!-- Materiais Diversos -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-6">
            <label class="block font-medium text-gray-700 mb-2">Materiais Diversos:</label>
            <textarea id="materiaisDiversos" placeholder="Digite materiais diversos..." rows="4" 
                      class="input-field"></textarea>
        </div>

        <!-- Send Report Button -->
        <button onclick="showConfirmationPopup()" class="w-full btn-success p-4 text-xl mb-6">
            Enviar Relat√≥rio
        </button>
        
        <!-- Version Info -->
        <div class="version-text">Vers√£o 1.0</div>
    </div>

    <!-- Completion Screen -->
    <div class="completion-screen">
        <div class="bg-white p-8 rounded-xl shadow-md mx-auto" style="max-width: 28rem;">
            <div style="font-size: 4rem; color: #10b981; margin-bottom: 1rem;">‚úì</div>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Relat√≥rio Enviado</h2>
            <p class="text-gray-600 mb-6">Relat√≥rio enviado com sucesso!</p>
            <button onclick="startNewReport()" class="btn-primary w-full">
                Novo Relat√≥rio
            </button>
            <div class="version-text" style="margin-top: 20px;">Vers√£o 1.0</div>
        </div>
    </div>

    <!-- Pop-up de Confirma√ß√£o -->
    <div class="confirm-popup" id="confirmPopup">
        <div class="confirm-content">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Confirma√ß√£o</h3>
            <p class="text-gray-600 mb-6">Tem certeza que deseja finalizar a opera√ß√£o?</p>
            <div class="confirm-buttons">
                <button onclick="hideConfirmationPopup()" class="btn-cancel">
                    Cancelar
                </button>
                <button onclick="confirmSendReport()" class="btn-success">
                    Sim
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        // Produtos de demonstra√ß√£o para visualiza√ß√£o
        const mockProducts = [
            { codigo: "40016", nome: "PARAF.AUTO COMPRESSIVO CANULADO 16", ordem_global: 1163 },
            { codigo: "40018", nome: "PARAF.AUTO COMPRESSIVO CANULADO 18", ordem_global: 1164 },
            { codigo: "40020", nome: "PARAF.AUTO COMPRESSIVO CANULADO 20", ordem_global: 1165 },
            { codigo: "40022", nome: "PARAF.AUTO COMPRESSIVO CANULADO 22", ordem_global: 1166 },
            { codigo: "40024", nome: "PARAF.AUTO COMPRESSIVO CANULADO 24", ordem_global: 1167 },
            { codigo: "40026", nome: "PARAF.AUTO COMPRESSIVO CANULADO 26", ordem_global: 1168 },
            { codigo: "40028", nome: "PARAF.AUTO COMPRESSIVO CANULADO 28", ordem_global: 1169 },
            { codigo: "40030", nome: "PARAF.AUTO COMPRESSIVO CANULADO 30", ordem_global: 1170 },
            { codigo: "2.001.09150", nome: "FIO GUIA 0,9X150mm", ordem_global: 1171 }
        ];

        const placasMockProducts = [
            { codigo: "211.304", nome: "PLACA EM T 4,5MM 4 FUROS", ordem_global: 2001 },
            { codigo: "211.306", nome: "PLACA EM T 4,5MM 6 FUROS", ordem_global: 2002 },
            { codigo: "211.308", nome: "PLACA EM T 4,5MM 8 FUROS", ordem_global: 2003 },
            { codigo: "212.404", nome: "PLACA SEMITUBULAR 4,5MM 4 FUROS", ordem_global: 2004 },
            { codigo: "212.406", nome: "PLACA SEMITUBULAR 4,5MM 6 FUROS", ordem_global: 2005 },
            { codigo: "212.408", nome: "PLACA SEMITUBULAR 4,5MM 8 FUROS", ordem_global: 2006 }
        ];

        const hastesMockProducts = [
            { codigo: "H1040", nome: "HASTE INTRAMEDULAR FEMORAL 10MM X 40CM", ordem_global: 3001 },
            { codigo: "H1042", nome: "HASTE INTRAMEDULAR FEMORAL 10MM X 42CM", ordem_global: 3002 },
            { codigo: "H1140", nome: "HASTE INTRAMEDULAR FEMORAL 11MM X 40CM", ordem_global: 3003 },
            { codigo: "H1142", nome: "HASTE INTRAMEDULAR FEMORAL 11MM X 42CM", ordem_global: 3004 }
        ];

        let currentProducts = [];
        
        // Filter products - Vers√£o demonstrativa
        function filterProducts() {
            const subgrupo = document.getElementById('documentType').value;
            const container = document.getElementById('productsContainer');
            
            if (!subgrupo) {
                container.innerHTML = '<div class="text-center p-8 text-gray-600">Selecione um subgrupo</div>';
                return;
            }
            
            container.innerHTML = '<div class="text-center p-8 text-blue-600"><div class="loading-spinner"></div>Buscando produtos...</div>';
            
            // Simula√ß√£o de carregamento
            setTimeout(() => {
                if (subgrupo === "PARAFUSOS CANUL COMPR HEBBERT") {
                    currentProducts = mockProducts;
                } else if (subgrupo.includes("PLACAS")) {
                    currentProducts = placasMockProducts;
                } else if (subgrupo.includes("HASTES")) {
                    currentProducts = hastesMockProducts;
                } else {
                    // Produtos gen√©ricos para outros subgrupos
                    currentProducts = [
                        { codigo: "G001", nome: `ITEM 1 - ${subgrupo}`, ordem_global: 5001 },
                        { codigo: "G002", nome: `ITEM 2 - ${subgrupo}`, ordem_global: 5002 },
                        { codigo: "G003", nome: `ITEM 3 - ${subgrupo}`, ordem_global: 5003 },
                        { codigo: "G004", nome: `ITEM 4 - ${subgrupo}`, ordem_global: 5004 }
                    ];
                }
                
                renderProducts();
            }, 500);
        }
        
        // Capitalize input
        function capitalizeInput(input) {
            const words = input.value.toLowerCase().split(' ');
            input.value = words.map(word => 
                word.length > 0 ? word.charAt(0).toUpperCase() + word.slice(1) : word
            ).join(' ');
        }
        
        // Render products
        function renderProducts() {
            const container = document.getElementById('productsContainer');
            container.innerHTML = '';
            
            if (currentProducts.length === 0) {
                container.innerHTML = '<div class="text-center p-8 text-gray-600">Nenhum produto encontrado</div>';
                return;
            }
            
            currentProducts.forEach((product, index) => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.innerHTML = `
                    <div class="flex items-start gap-3">
                        <input type="checkbox" onchange="toggleProductSelection(${index})" 
                               class="mt-1 w-5 h-5" id="checkbox-${index}">
                        <div class="flex-1">
                            <div class="font-medium text-gray-900">${product.nome}</div>
                            <div class="text-gray-500 text-sm">C√≥digo: ${product.codigo}</div>
                        </div>
                    </div>
                    <div class="qty-controls" id="qty-controls-${index}">
                        <div class="qty-row">
                            <div class="qty-left">
                                <span class="qty-label">Qtd:</span>
                                <select class="qty-select">
                                    <option value="1" selected>1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                    <option value="6">6</option>
                                    <option value="7">7</option>
                                    <option value="8">8</option>
                                    <option value="9">9</option>
                                    <option value="10">10</option>
                                </select>
                                <span class="qty-label">Lote:</span>
                                <input type="text" placeholder="Lote" maxlength="15" class="lot-input">
                            </div>
                            <div class="qty-buttons">
                                <button onclick="addLot(${index})" class="add-btn">+</button>
                            </div>
                        </div>
                        <div id="additional-lots-${index}"></div>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        // Toggle product selection
        function toggleProductSelection(index) {
            const checkbox = document.getElementById(`checkbox-${index}`);
            const controls = document.getElementById(`qty-controls-${index}`);
            const card = checkbox.closest('.product-card');
            
            if (checkbox.checked) {
                controls.classList.add('show');
                card.classList.add('selected');
            } else {
                controls.classList.remove('show');
                card.classList.remove('selected');
                document.getElementById(`additional-lots-${index}`).innerHTML = '';
            }
        }
        
        // Add lot
        function addLot(productIndex) {
            const container = document.getElementById(`additional-lots-${productIndex}`);
            const lotDiv = document.createElement('div');
            lotDiv.className = 'qty-row';
            lotDiv.style.backgroundColor = '#f3f4f6';
            lotDiv.style.padding = '0.5rem';
            lotDiv.style.borderRadius = '0.375rem';
            lotDiv.innerHTML = `
                <div class="qty-left">
                    <span class="qty-label">Qtd:</span>
                    <select class="qty-select">
                        <option value="1" selected>1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                    </select>
                    <span class="qty-label">Lote:</span>
                    <input type="text" placeholder="Lote" maxlength="15" class="lot-input">
                </div>
                <div class="qty-buttons">
                    <button onclick="removeLot(this)" class="remove-btn">-</button>
                </div>
            `;
            container.appendChild(lotDiv);
        }
        
        // Remove lot
        function removeLot(button) {
            button.closest('.qty-row').remove();
        }
        
        // Show selected only
        function showSelectedOnly() {
            const cards = document.querySelectorAll('.product-card');
            cards.forEach(card => {
                const checkbox = card.querySelector('input[type="checkbox"]');
                if (!checkbox.checked) {
                    card.style.display = 'none';
                }
            });
        }
        
        // Show all products
        function showAllProducts() {
            const cards = document.querySelectorAll('.product-card');
            cards.forEach(card => {
                card.style.display = 'block';
            });
        }
        
        // Format date
        function formatDateBrazilian(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('pt-BR');
        }
        
        // Generate separator line
        function generateSeparator(length = 32) {
            return '='.repeat(length);
        }
        
        // Generate PDF
        function generatePDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Novo cabe√ßalho com HEXAGON
                doc.setFontSize(20);
                doc.setFont(undefined, 'bold');
                doc.text('HEXAGON', 105, 15, { align: 'center' });
                
                doc.setFontSize(14);
                doc.text('REGISTRO DE CONSUMO DE MATERIAIS CONSIGNADOS', 105, 25, { align: 'center' });
                
                let yPos = 35;
                
                // Separator
                doc.setFontSize(10);
                doc.text(generateSeparator(50), 105, yPos, { align: 'center' });
                yPos += 10;
                
                // Patient info
                doc.setFont(undefined, 'normal');
                doc.text(`Usu√°rio: ${document.getElementById('userField').value || ''}`, 20, yPos);
                yPos += 6;
                doc.text(`Hospital: ${document.getElementById('hospitalSelect').value || ''}`, 20, yPos);
                yPos += 6;
                doc.text(`Nome do Paciente: ${document.getElementById('patientName').value || ''}`, 20, yPos);
                yPos += 6;
                doc.text(`Num Prontuario: ${document.getElementById('recordNumber').value || ''}`, 20, yPos);
                yPos += 6;
                doc.text(`Data da Cirurgia: ${formatDateBrazilian(document.getElementById('surgeryDate').value)}`, 20, yPos);
                yPos += 6;
                doc.text(`Outras Informa√ß√µes: ${document.getElementById('otherInfo').value || ''}`, 20, yPos);
                yPos += 10;
                
                // Separator
                doc.text(generateSeparator(50), 105, yPos, { align: 'center' });
                yPos += 10;
                
                // Materials - CORRIGIDO para incluir todos os lotes adicionais
                const checkboxes = document.querySelectorAll('.product-card input[type="checkbox"]:checked');
                checkboxes.forEach(checkbox => {
                    const index = parseInt(checkbox.id.split('-')[1]);
                    const product = currentProducts[index];
                    
                    // Obter TODAS as linhas de lote (inicial + adicionais)
                    const qtyControls = document.getElementById(`qty-controls-${index}`);
                    const allLotRows = qtyControls.querySelectorAll('.qty-row');
                    
                    // Processar cada linha de lote
                    allLotRows.forEach(row => {
                        const qtySelect = row.querySelector('select');
                        const lotInput = row.querySelector('input[type="text"]');
                        
                        if (lotInput && lotInput.value) {
                            doc.text(`Codigo: ${product.codigo}`, 20, yPos);
                            yPos += 5;
                            doc.text(`Produto: ${product.nome}`, 20, yPos);
                            yPos += 5;
                            doc.text(`Lote: ${lotInput.value}`, 20, yPos);
                            yPos += 5;
                            doc.text(`Quantidade: ${qtySelect.value || '1'}`, 20, yPos);
                            yPos += 10;
                            
                            // Separator
                            doc.text(generateSeparator(50), 105, yPos, { align: 'center' });
                            yPos += 10;
                            
                            if (yPos > 260) {
                                doc.addPage();
                                yPos = 20;
                            }
                        }
                    });
                });
                
                // Materiais Diversos
                const diversos = document.getElementById('materiaisDiversos').value;
                if (diversos) {
                    doc.text('Materiais Diversos:', 20, yPos);
                    yPos += 6;
                    doc.text(diversos, 20, yPos);
                    yPos += 10;
                    
                    // Final separator
                    doc.text(generateSeparator(50), 105, yPos, { align: 'center' });
                }
                
                return doc;
                
            } catch (error) {
                console.error('Erro PDF:', error);
                throw error;
            }
        }

        // Show confirmation popup
        function showConfirmationPopup() {
            // Valida√ß√µes simples
            const userField = document.getElementById('userField').value.trim();
            const hospitalSelect = document.getElementById('hospitalSelect').value.trim();
            const surgeryDate = document.getElementById('surgeryDate').value.trim();
            const documentType = document.getElementById('documentType').value.trim();
            
            if (!userField) {
                alert('Preencha o campo Usu√°rio');
                return;
            }
            
            if (!hospitalSelect) {
                alert('Preencha o campo Hospital');
                return;
            }

            if (!surgeryDate) {
                alert('Preencha o campo Data da Cirurgia');
                return;
            }

            if (!documentType) {
                alert('Selecione um subgrupo');
                return;
            }
            
            // Mostrar popup
            document.getElementById('confirmPopup').classList.add('show');
        }

        // Hide confirmation popup
        function hideConfirmationPopup() {
            document.getElementById('confirmPopup').classList.remove('show');
        }

        // Confirm send report
        function confirmSendReport() {
            hideConfirmationPopup();
            sendReport();
        }

        // Send report
        function sendReport() {
            try {
                const userField = document.getElementById('userField').value.trim();
                const hospitalSelect = document.getElementById('hospitalSelect').value.trim();
                
                // Mensagem WhatsApp atualizada
                let message = 'HEXAGON\n';
                message += 'REGISTRO DE CONSUMO DE MATERIAIS CONSIGNADOS\n';
                message += generateSeparator() + '\n';
                
                // T√≠tulos em negrito
                message += `*Usu√°rio:* ${userField}\n`;
                message += `*Hospital:* ${hospitalSelect}\n`;
                message += `*Nome do Paciente:* ${document.getElementById('patientName').value || ''}\n`;
                message += `*Num Prontuario:* ${document.getElementById('recordNumber').value || ''}\n`;
                message += `*Data da Cirurgia:* ${formatDateBrazilian(document.getElementById('surgeryDate').value) || ''}\n`;
                message += `*Outras Informa√ß√µes:* ${document.getElementById('otherInfo').value || ''}\n`;
                message += generateSeparator() + '\n';
                
                // Produtos selecionados com todos os lotes
                const checkboxes = document.querySelectorAll('.product-card input[type="checkbox"]:checked');
                
                checkboxes.forEach(checkbox => {
                    const index = parseInt(checkbox.id.split('-')[1]);
                    const product = currentProducts[index];
                    
                    // Obter todas as linhas de lote
                    const qtyControls = document.getElementById(`qty-controls-${index}`);
                    const allLotRows = qtyControls.querySelectorAll('.qty-row');
                    
                    // Processar cada linha
                    allLotRows.forEach(row => {
                        const qtySelect = row.querySelector('select');
                        const lotInput = row.querySelector('input[type="text"]');
                        
                        if (lotInput && lotInput.value) {
                            // T√≠tulos em negrito
                            message += `*Codigo:* ${product.codigo}\n`;
                            message += `*Produto:* ${product.nome}\n`;
                            message += `*Lote:* ${lotInput.value}\n`;
                            message += `*Quantidade:* ${qtySelect.value || '1'}\n`;
                            message += generateSeparator() + '\n';
                        }
                    });
                });
                
                // Materiais Diversos
                const diversos = document.getElementById('materiaisDiversos').value;
                if (diversos) {
                    message += '*Materiais Diversos:*\n';
                    message += diversos + '\n';
                    message += generateSeparator() + '\n';
                }
                
                // Generate PDF
                try {
                    const pdf = generatePDF();
                    const pdfBlob = pdf.output('blob');
                    const pdfUrl = URL.createObjectURL(pdfBlob);
                    
                    const link = document.createElement('a');
                    link.href = pdfUrl;
                    link.download = `Hexagon_${new Date().toISOString().slice(0,10)}.pdf`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    console.log('PDF gerado com sucesso!');
                    
                } catch (pdfError) {
                    console.error('Erro PDF:', pdfError);
                }
                
                // Simular envio WhatsApp
                console.log('Mensagem do WhatsApp:');
                console.log(message);
                
                alert('Relat√≥rio gerado com sucesso!\n\nNo ambiente de produ√ß√£o, um link do WhatsApp seria aberto para envio da mensagem.');
                
                // Exibir tela de conclus√£o
                showCompletionScreen();
                
            } catch (error) {
                console.error('Erro ao enviar:', error);
                alert('Erro ao enviar relat√≥rio');
            }
        }

        // Show completion screen
        function showCompletionScreen() {
            document.querySelector('.main-content').classList.add('hide');
            document.querySelector('.completion-screen').classList.add('show');
        }

        // Start new report
        function startNewReport() {
            document.getElementById('userField').value = '';
            document.getElementById('hospitalSelect').value = '';
            document.getElementById('patientName').value = '';
            document.getElementById('recordNumber').value = '';
            document.getElementById('surgeryDate').value = '';
            document.getElementById('otherInfo').value = '';
            document.getElementById('materiaisDiversos').value = '';
            document.getElementById('documentType').value = '';
            document.getElementById('productsContainer').innerHTML = 
                '<div class="text-center p-8 text-gray-600">Selecione um subgrupo para visualizar os produtos</div>';
            
            document.querySelector('.main-content').classList.remove('hide');
            document.querySelector('.completion-screen').classList.remove('show');
        }
        
        // PWA Install handling
        let deferredPrompt;
        const installButton = document.getElementById('installButton');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installButton.style.display = 'block';
        });

        installButton.addEventListener('click', () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('‚úÖ PWA instalado');
                        installButton.style.display = 'none';
                    }
                    deferredPrompt = null;
                });
            }
        });
    </script>
</body>
</html>
    <script id="html_badge_script1">
        window.__genspark_remove_badge_link = "https://www.genspark.ai/api/html_badge/" +
            "remove_badge?token=To%2FBnjzloZ3UfQdcSaYfDuS8BJvaLI37bsp%2FlXnlRmBJapCXBXyWFtITsZIJprIkzwMNnVNkRqlxJqKv8r5Rm2oE6dKkJnrw9c%2FF6JD4pxHuoY3hbRO0QQLwUxbthfV01nx1y8nBHXqjiivNdxhvpmAWXBoNObbzULsuK%2FqUoEOvk6DfQKFFnpGHIs8yVprOvYKgssi0yWZIGKDCPYJKRpjlOCZvI8RtpYwbQT%2B9Q9TeGlxmyR%2FoIvKoPMq9hcVa8cLePq7NAJpOXA1tH7nZBvm9gKrSY7S2fk1fYzTnddMB7Z7xBCDGyOHA9pdAsTiiMJRD1Diqk%2FEOojhI7yhpHJqncrmJwApMRZJDTN%2FZHPx5I5vYbIVHG9j5gOpo0tWDC%2FqcxGAaXybeSLovjVUhwTrakuJcXmItktact04S%2BrlJSd8%2FRQ0JdQmDvHtcyHcZtOjCg3ae1D9zMFhsf23RM998DnsgVP6hpm6t996YsRysw734edJYpXHRspOy0AZVPnJ00Hr4MDyl6Kj0hPEU9g%3D%3D";
        window.__genspark_locale = "pt-BR";
        window.__genspark_token = "To/BnjzloZ3UfQdcSaYfDuS8BJvaLI37bsp/lXnlRmBJapCXBXyWFtITsZIJprIkzwMNnVNkRqlxJqKv8r5Rm2oE6dKkJnrw9c/F6JD4pxHuoY3hbRO0QQLwUxbthfV01nx1y8nBHXqjiivNdxhvpmAWXBoNObbzULsuK/qUoEOvk6DfQKFFnpGHIs8yVprOvYKgssi0yWZIGKDCPYJKRpjlOCZvI8RtpYwbQT+9Q9TeGlxmyR/oIvKoPMq9hcVa8cLePq7NAJpOXA1tH7nZBvm9gKrSY7S2fk1fYzTnddMB7Z7xBCDGyOHA9pdAsTiiMJRD1Diqk/EOojhI7yhpHJqncrmJwApMRZJDTN/ZHPx5I5vYbIVHG9j5gOpo0tWDC/qcxGAaXybeSLovjVUhwTrakuJcXmItktact04S+rlJSd8/RQ0JdQmDvHtcyHcZtOjCg3ae1D9zMFhsf23RM998DnsgVP6hpm6t996YsRysw734edJYpXHRspOy0AZVPnJ00Hr4MDyl6Kj0hPEU9g==";
    </script>
    
    <script id="html_notice_dialog_script" src="https://www.genspark.ai/notice_dialog.js"></script>
    
