<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HEXAGON - Firebase Inline</title>
    
    <style>
        /* Reset e Base */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f9fafb; color: #1f2937; line-height: 1.6; }
        
        /* Utilit√°rios Tailwind Inline */
        .bg-gray-50 { background-color: #f9fafb; }
        .bg-white { background-color: #ffffff; }
        .bg-blue-600 { background-color: #2563eb; }
        .bg-green-500 { background-color: #10b981; }
        .text-gray-800 { color: #1f2937; }
        .text-gray-700 { color: #374151; }
        .text-gray-600 { color: #4b5563; }
        .text-blue-600 { color: #2563eb; }
        .text-white { color: #ffffff; }
        .font-bold { font-weight: 700; }
        .font-semibold { font-weight: 600; }
        .font-medium { font-weight: 500; }
        .text-xl { font-size: 1.25rem; }
        .text-4xl { font-size: 2.25rem; }
        .p-3 { padding: 0.75rem; }
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        .p-8 { padding: 2rem; }
        .pt-8 { padding-top: 2rem; }
        .pb-6 { padding-bottom: 1.5rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .border { border-width: 1px; }
        .border-gray-300 { border-color: #d1d5db; }
        .w-full { width: 100%; }
        .max-w-6xl { max-width: 72rem; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .text-center { text-align: center; }
        .grid { display: grid; }
        .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .shadow-md { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .min-h-screen { min-height: 100vh; }
        .cursor-pointer { cursor: pointer; }
        .transition-all { transition: all 0.3s ease; }
        
        @media (min-width: 768px) {
            .md\\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        }
        
        /* Componentes Espec√≠ficos */
        .btn-primary {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(37, 99, 235, 0.2);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .product-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }
        
        .product-card.selected {
            border-color: #2563eb;
            background-color: #f8fafc;
            box-shadow: 0 4px 6px rgba(37, 99, 235, 0.1);
        }
        
        .qty-controls {
            display: none;
            margin-top: 0.75rem;
            padding: 0.75rem;
            background-color: #f9fafb;
            border-radius: 0.375rem;
            border: 1px solid #e5e7eb;
        }
        
        .qty-controls.show {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            transition: border-color 0.2s;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .completion-screen {
            display: none;
            text-align: center;
            padding: 3rem;
        }
        
        .completion-screen.show {
            display: block;
        }
        
        .main-content.hide {
            display: none;
        }
        
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #2563eb;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 0.5rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    
    <!-- HEXAGON Title -->
    <div class="pt-8 pb-6 text-center">
        <h1 class="text-4xl font-bold text-gray-800 mb-2">üî• HEXAGON</h1>
        <h2 class="text-xl font-semibold text-gray-700 mb-2">Registro de Materiais Ortop√©dicos</h2>
        <div class="text-blue-600 font-medium">Firebase ‚Ä¢ 11 Cole√ß√µes ‚Ä¢ 1.352 Produtos</div>
    </div>

    <!-- Main Content -->
    <div class="main-content max-w-6xl mx-auto px-4">
        
        <!-- Patient Information -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-6">
            <h3 class="font-semibold mb-4 text-gray-800">üë§ Informa√ß√µes do Paciente</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block font-medium text-gray-700 mb-2">Usu√°rio *</label>
                    <input type="text" id="userField" placeholder="Nome do usu√°rio" 
                           class="input-field" oninput="capitalizeInput(this)">
                </div>
                
                <div>
                    <label class="block font-medium text-gray-700 mb-2">Hospital *</label>
                    <input type="text" id="hospitalSelect" placeholder="Nome do hospital" 
                           class="input-field" oninput="capitalizeInput(this)">
                </div>
                
                <div>
                    <label class="block font-medium text-gray-700 mb-2">Paciente</label>
                    <input type="text" id="patientName" placeholder="Nome do paciente" 
                           class="input-field" oninput="capitalizeInput(this)">
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block font-medium text-gray-700 mb-2">N¬∞ Prontu√°rio</label>
                    <input type="text" id="recordNumber" placeholder="N√∫mero do prontu√°rio" 
                           class="input-field">
                </div>
                
                <div>
                    <label class="block font-medium text-gray-700 mb-2">Data Cirurgia</label>
                    <input type="date" id="surgeryDate" class="input-field">
                </div>
                
                <div>
                    <label class="block font-medium text-gray-700 mb-2">Outras Informa√ß√µes</label>
                    <textarea id="otherInfo" placeholder="Informa√ß√µes adicionais" rows="2" 
                              class="input-field"></textarea>
                </div>
            </div>
        </div>

        <!-- Product Selection -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-6">
            <div class="mb-4">
                <label class="block font-medium text-gray-700 mb-2">üì¶ Selecionar Subgrupo:</label>
                <select id="documentType" onchange="filterProducts()" class="input-field">
                    <option value="">üîÑ Carregando subgrupos...</option>
                </select>
            </div>

            <div id="productsContainer">
                <div class="text-center p-8 text-gray-600">
                    ‚òùÔ∏è Selecione um subgrupo para visualizar os produtos
                </div>
            </div>
        </div>

        <!-- Filter Buttons -->
        <div class="grid grid-cols-2 gap-3 mb-6">
            <button onclick="showSelectedOnly()" class="btn-success">
                üîç Filtrar Selecionados
            </button>
            <button onclick="showAllProducts()" class="btn-primary">
                üëÅÔ∏è Mostrar Todos
            </button>
        </div>

        <!-- Materiais Diversos -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-6">
            <label class="block font-medium text-gray-700 mb-2">‚ûï Materiais Diversos:</label>
            <textarea id="materiaisDiversos" placeholder="Digite materiais diversos..." rows="4" 
                      class="input-field"></textarea>
        </div>

        <!-- Send Report Button -->
        <button onclick="sendReport()" class="w-full btn-success p-4 text-xl mb-6">
            üì§ Enviar Relat√≥rio
        </button>
    </div>

    <!-- Completion Screen -->
    <div class="completion-screen">
        <div class="bg-white p-8 rounded-xl shadow-md mx-auto" style="max-width: 28rem;">
            <div style="font-size: 4rem; color: #10b981; margin-bottom: 1rem;">‚úÖ</div>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Relat√≥rio Enviado</h2>
            <p class="text-gray-600 mb-6">Relat√≥rio enviado com sucesso!</p>
            <button onclick="startNewReport()" class="btn-primary w-full">
                ‚ûï Novo Relat√≥rio
            </button>
        </div>
    </div>

    <script>
        // Firebase SDK v9 Inline
        !function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).firebase={})}(this,function(e){"use strict";var t,n;e.SDK_VERSION="9.23.0",e.DEFAULT_ENTRY_NAME="[DEFAULT]",e._apps=new Map,e._components=new Map;try{(t=globalThis.process)===null||t===void 0?void 0:t.env}catch{}try{(n=globalThis.process)===null||n===void 0?void 0:n.env}catch{}let r=class{constructor(e,t,n){this.name=e,this.instanceFactory=t,this.type=n,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(e){return this.instantiationMode=e,this}setMultipleInstances(e){return this.multipleInstances=e,this}setServiceProps(e){return this.serviceProps=e,this}setInstanceCreatedCallback(e){return this.onInstanceCreated=e,this}};
        
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDnJsxMxCLCcpqYCxrO4njbxKMTqoOpmtg",
            authDomain: "app-hexagon-materiais.firebaseapp.com",
            projectId: "app-hexagon-materiais",
            storageBucket: "app-hexagon-materiais.firebasestorage.app",
            messagingSenderId: "810793753497",
            appId: "1:810793753497:web:b5a6a812b18e09bfdd5108"
        };

        // Simula√ß√£o do Firebase (vers√£o simplificada para demonstra√ß√£o)
        const firebase = {
            initializeApp: function(config) {
                console.log('üî• Firebase inicializado:', config.projectId);
                return { config };
            },
            firestore: function() {
                return {
                    collection: function(name) {
                        return {
                            orderBy: function(field) {
                                return {
                                    limit: function(num) {
                                        return {
                                            get: async function() {
                                                // Simula√ß√£o de dados - substitua pela implementa√ß√£o real
                                                console.log(`üìÇ Consultando cole√ß√£o: ${name}`);
                                                return {
                                                    forEach: function(callback) {
                                                        // Dados de exemplo
                                                        const exemplos = [
                                                            { data: () => ({ grupo: 'PARAFUSOS CANULADOS', subgrupo: 'PARAFUSOS CANULADOS √ò7mm', codigo: '12345', descricao: 'Parafuso Exemplo', ordem_global: 1 }) }
                                                        ];
                                                        exemplos.forEach(callback);
                                                    }
                                                };
                                            }
                                        };
                                    }
                                };
                            },
                            where: function(field, op, value) {
                                return {
                                    orderBy: function(orderField) {
                                        return {
                                            limit: function(num) {
                                                return {
                                                    get: async function() {
                                                        console.log(`üîç Filtrando ${field} ${op} ${value}`);
                                                        return {
                                                            forEach: function(callback) {
                                                                // Produtos de exemplo para o subgrupo
                                                                const produtos = [
                                                                    { data: () => ({ codigo: '001', descricao: 'Produto Exemplo 1', ordem_global: 1 }) },
                                                                    { data: () => ({ codigo: '002', descricao: 'Produto Exemplo 2', ordem_global: 2 }) }
                                                                ];
                                                                produtos.forEach(callback);
                                                            }
                                                        };
                                                    }
                                                };
                                            }
                                        };
                                    }
                                };
                            }
                        };
                    }
                };
            }
        };

        // jsPDF Inline (vers√£o simplificada)
        window.jspdf = {
            jsPDF: class {
                constructor() {
                    this.content = [];
                }
                setFontSize(size) { this.fontSize = size; }
                setFont(family, style) { this.fontStyle = style; }
                text(text, x, y, options = {}) {
                    this.content.push({ text, x, y, options, fontSize: this.fontSize, fontStyle: this.fontStyle });
                }
                addPage() { this.content.push({ type: 'newPage' }); }
                splitTextToSize(text, maxWidth) {
                    return text.split(' ').reduce((lines, word) => {
                        const lastLine = lines[lines.length - 1] || '';
                        if ((lastLine + ' ' + word).length > maxWidth / 5) {
                            lines.push(word);
                        } else {
                            lines[lines.length - 1] = (lastLine + ' ' + word).trim();
                        }
                        return lines;
                    }, ['']);
                }
                output(type) {
                    if (type === 'blob') {
                        const pdfContent = this.content.map(item => 
                            item.text ? `${item.text}` : item.type
                        ).join('\n');
                        return new Blob([pdfContent], { type: 'application/pdf' });
                    }
                }
            }
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Collections
        const COLLECTIONS = [
            'parafusos_canulados', 'fixadores_externos', 'placas_sem_bloqueio_gr_frag',
            'placas_com_bloqueio_pequ_frag', 'hastes_intram_femur', 'hastes_intram_tibia',
            'hastes_intram_umero', 'micro_placas_com_bloqueio', 'placas_com_bloqueio_gr_frag',
            'placas_sem_bloqueio_pequ_frag', 'placas_volares_com_bloqueio'
        ];
        
        // Global variables
        let currentProducts = [];
        let allSubgroups = new Map();
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Hexagon Firebase iniciado');
            await carregarSubgrupos();
        });
        
        // Capitalize input
        function capitalizeInput(input) {
            const words = input.value.toLowerCase().split(' ');
            input.value = words.map(word => 
                word.length > 0 ? word.charAt(0).toUpperCase() + word.slice(1) : word
            ).join(' ');
        }
        
        // Load subgroups
        async function carregarSubgrupos() {
            try {
                const select = document.getElementById('documentType');
                select.innerHTML = '<option value="">üîÑ Carregando...</option>';
                
                const gruposOrganizados = {};
                
                for (const collection of COLLECTIONS) {
                    try {
                        const snapshot = await db.collection(collection).orderBy('ordem_global').limit(500).get();
                        
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            if (data.grupo && data.subgrupo) {
                                const grupo = data.grupo.trim();
                                const subgrupo = data.subgrupo.trim();
                                
                                if (!gruposOrganizados[grupo]) {
                                    gruposOrganizados[grupo] = new Set();
                                }
                                gruposOrganizados[grupo].add(subgrupo);
                                allSubgroups.set(subgrupo, collection);
                            }
                        });
                    } catch (error) {
                        console.warn(`Erro na cole√ß√£o ${collection}:`, error);
                    }
                }
                
                // Build dropdown
                select.innerHTML = '<option value="">üìã Selecione um subgrupo</option>';
                
                Object.keys(gruposOrganizados).sort().forEach(grupo => {
                    const headerOption = document.createElement('option');
                    headerOption.value = '';
                    headerOption.textContent = `‚ïê‚ïê‚ïê ${grupo} ‚ïê‚ïê‚ïê`;
                    headerOption.disabled = true;
                    headerOption.style.fontWeight = 'bold';
                    headerOption.style.backgroundColor = '#374151';
                    headerOption.style.color = 'white';
                    select.appendChild(headerOption);
                    
                    Array.from(gruposOrganizados[grupo]).sort().forEach(subgrupo => {
                        const option = document.createElement('option');
                        option.value = subgrupo;
                        option.textContent = `  üì¶ ${subgrupo}`;
                        select.appendChild(option);
                    });
                });
                
                console.log('‚úÖ Subgrupos carregados');
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar subgrupos:', error);
                document.getElementById('documentType').innerHTML = '<option value="">‚ùå Erro ao carregar</option>';
            }
        }
        
        // Filter products
        async function filterProducts() {
            const subgrupo = document.getElementById('documentType').value;
            const container = document.getElementById('productsContainer');
            
            if (!subgrupo) {
                container.innerHTML = '<div class="text-center p-8 text-gray-600">‚òùÔ∏è Selecione um subgrupo</div>';
                return;
            }
            
            container.innerHTML = '<div class="text-center p-8 text-blue-600"><div class="loading-spinner"></div>Buscando produtos...</div>';
            
            try {
                const collection = allSubgroups.get(subgrupo);
                if (!collection) {
                    container.innerHTML = '<div class="text-center p-8 text-red-600">‚ùå Cole√ß√£o n√£o encontrada</div>';
                    return;
                }
                
                const snapshot = await db.collection(collection)
                    .where('subgrupo', '==', subgrupo)
                    .orderBy('ordem_global')
                    .limit(500)
                    .get();
                
                const produtos = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    produtos.push({
                        codigo: data.codigo,
                        nome: data.descricao || data.nome,
                        ordem_global: data.ordem_global
                    });
                });
                
                currentProducts = produtos;
                renderProducts();
                
            } catch (error) {
                console.error('‚ùå Erro ao buscar produtos:', error);
                container.innerHTML = '<div class="text-center p-8 text-red-600">‚ùå Erro de conex√£o</div>';
            }
        }
        
        // Render products
        function renderProducts() {
            const container = document.getElementById('productsContainer');
            container.innerHTML = '';
            
            if (currentProducts.length === 0) {
                container.innerHTML = '<div class="text-center p-8 text-gray-600">üîç Nenhum produto encontrado</div>';
                return;
            }
            
            const headerDiv = document.createElement('div');
            headerDiv.className = 'mb-4 p-4 bg-blue-50 rounded-lg border border-blue-200';
            headerDiv.innerHTML = `
                <div class="flex items-center justify-between">
                    <span class="text-blue-800 font-medium">üì¶ ${currentProducts.length} produtos encontrados</span>
                    <span class="text-blue-600">Ordenados por: Ordem Global</span>
                </div>
            `;
            container.appendChild(headerDiv);
            
            currentProducts.forEach((product, index) => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.innerHTML = `
                    <div class="flex items-start gap-3">
                        <input type="checkbox" onchange="toggleProductSelection(${index})" 
                               class="mt-1 w-5 h-5" id="checkbox-${index}">
                        <div class="flex-1">
                            <div class="font-medium text-gray-900">${product.nome}</div>
                            <div class="text-gray-500 text-sm">C√≥digo: ${product.codigo}</div>
                            <div class="text-blue-500 text-xs">Ordem: ${product.ordem_global}</div>
                        </div>
                    </div>
                    <div class="qty-controls" id="qty-controls-${index}">
                        <div class="flex items-center gap-2">
                            <label class="font-medium">Qtd:</label>
                            <select class="p-2 border rounded" style="width: 70px;">
                                <option value="">-</option>
                                ${Array.from({length: 10}, (_, i) => `<option value="${i+1}">${i+1}</option>`).join('')}
                            </select>
                        </div>
                        <div class="flex items-center gap-2">
                            <label class="font-medium">Lote:</label>
                            <input type="text" placeholder="Lote" maxlength="15" 
                                   class="p-2 border rounded" style="width: 120px;">
                            <button onclick="addLot(${index})" 
                                    class="bg-blue-600 text-white p-2 rounded hover:bg-blue-700">
                                ‚ûï
                            </button>
                        </div>
                        <div id="additional-lots-${index}"></div>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        // Toggle product selection
        function toggleProductSelection(index) {
            const checkbox = document.getElementById(`checkbox-${index}`);
            const controls = document.getElementById(`qty-controls-${index}`);
            const card = checkbox.closest('.product-card');
            
            if (checkbox.checked) {
                controls.classList.add('show');
                card.classList.add('selected');
            } else {
                controls.classList.remove('show');
                card.classList.remove('selected');
                document.getElementById(`additional-lots-${index}`).innerHTML = '';
            }
        }
        
        // Add lot
        function addLot(productIndex) {
            const container = document.getElementById(`additional-lots-${productIndex}`);
            const lotDiv = document.createElement('div');
            lotDiv.className = 'flex items-center gap-2 mt-2 p-2 bg-gray-100 rounded';
            lotDiv.innerHTML = `
                <label class="font-medium">Qtd:</label>
                <select class="p-1 border rounded" style="width: 60px;">
                    <option value="">-</option>
                    ${Array.from({length: 10}, (_, i) => `<option value="${i+1}">${i+1}</option>`).join('')}
                </select>
                <label class="font-medium">Lote:</label>
                <input type="text" placeholder="Lote" maxlength="15" 
                       class="p-1 border rounded" style="width: 100px;">
                <button onclick="removeLot(this)" 
                        class="bg-red-600 text-white p-1 rounded hover:bg-red-700">
                    ‚ûñ
                </button>
            `;
            container.appendChild(lotDiv);
        }
        
        // Remove lot
        function removeLot(button) {
            button.closest('div').remove();
        }
        
        // Show selected only
        function showSelectedOnly() {
            const cards = document.querySelectorAll('.product-card');
            cards.forEach(card => {
                const checkbox = card.querySelector('input[type="checkbox"]');
                if (!checkbox.checked) {
                    card.style.display = 'none';
                }
            });
        }
        
        // Show all products
        function showAllProducts() {
            const cards = document.querySelectorAll('.product-card');
            cards.forEach(card => {
                card.style.display = 'block';
            });
        }
        
        // Format date
        function formatDateBrazilian(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('pt-BR');
        }
        
        // Generate PDF
        function generatePDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(20);
                doc.setFont(undefined, 'bold');
                doc.text('HEXAGON - FIREBASE INLINE', 105, 20, { align: 'center' });
                
                let yPos = 40;
                doc.setFontSize(12);
                doc.text('REGISTRO DE CONSUMO DE MATERIAIS', 105, yPos, { align: 'center' });
                yPos += 15;
                
                doc.setFontSize(10);
                doc.text(`Usu√°rio: ${document.getElementById('userField').value || ''}`, 20, yPos);
                yPos += 7;
                doc.text(`Hospital: ${document.getElementById('hospitalSelect').value || ''}`, 20, yPos);
                yPos += 7;
                doc.text(`Paciente: ${document.getElementById('patientName').value || ''}`, 20, yPos);
                yPos += 7;
                doc.text(`Prontu√°rio: ${document.getElementById('recordNumber').value || ''}`, 20, yPos);
                yPos += 7;
                doc.text(`Data: ${formatDateBrazilian(document.getElementById('surgeryDate').value)}`, 20, yPos);
                yPos += 15;
                
                // Materials
                const checkboxes = document.querySelectorAll('.product-card input[type="checkbox"]:checked');
                checkboxes.forEach(checkbox => {
                    const index = parseInt(checkbox.id.split('-')[1]);
                    const product = currentProducts[index];
                    
                    const qtyControls = document.getElementById(`qty-controls-${index}`);
                    const qtySelect = qtyControls.querySelector('select');
                    const lotInput = qtyControls.querySelector('input[type="text"]');
                    
                    if (lotInput.value) {
                        doc.text(`C√≥digo: ${product.codigo}`, 20, yPos);
                        yPos += 5;
                        doc.text(`Produto: ${product.nome}`, 20, yPos);
                        yPos += 5;
                        doc.text(`Lote: ${lotInput.value} | Qtd: ${qtySelect.value || '1'}`, 20, yPos);
                        yPos += 10;
                    }
                });
                
                const diversos = document.getElementById('materiaisDiversos').value;
                if (diversos) {
                    yPos += 5;
                    doc.text('Materiais Diversos:', 20, yPos);
                    yPos += 5;
                    const lines = doc.splitTextToSize(diversos, 170);
                    lines.forEach(line => {
                        doc.text(line, 20, yPos);
                        yPos += 5;
                    });
                }
                
                return doc;
                
            } catch (error) {
                console.error('Erro PDF:', error);
                throw error;
            }
        }

        // Send report
        function sendReport() {
            try {
                const userField = document.getElementById('userField').value.trim();
                const hospitalSelect = document.getElementById('hospitalSelect').value.trim();
                
                if (!userField) {
                    alert('‚ö†Ô∏è Preencha o campo Usu√°rio');
                    return;
                }
                
                if (!hospitalSelect) {
                    alert('‚ö†Ô∏è Preencha o campo Hospital');
                    return;
                }
                
                let message = 'üè• REGISTRO DE CONSUMO - HEXAGON FIREBASE\n';
                message += '===============================\n\n';
                message += `üë§ Usu√°rio: ${userField}\n`;
                message += `üè• Hospital: ${hospitalSelect}\n`;
                message += `ü§ï Paciente: ${document.getElementById('patientName').value || 'N/A'}\n`;
                message += `üìã Prontu√°rio: ${document.getElementById('recordNumber').value || 'N/A'}\n`;
                message += `üìÖ Data: ${formatDateBrazilian(document.getElementById('surgeryDate').value) || 'N/A'}\n`;
                message += `üìù Outras Info: ${document.getElementById('otherInfo').value || 'Nenhuma'}\n`;
                message += '===============================\n\n';
                
                // Materials
                const checkboxes = document.querySelectorAll('.product-card input[type="checkbox"]:checked');
                let materialCount = 0;
                
                if (checkboxes.length > 0) {
                    message += 'üì¶ MATERIAIS UTILIZADOS:\n';
                    
                    checkboxes.forEach(checkbox => {
                        const index = parseInt(checkbox.id.split('-')[1]);
                        const product = currentProducts[index];
                        
                        const qtyControls = document.getElementById(`qty-controls-${index}`);
                        const qtySelect = qtyControls.querySelector('select');
                        const lotInput = qtyControls.querySelector('input[type="text"]');
                        
                        if (lotInput.value) {
                            materialCount++;
                            message += `\n${materialCount}. üì¶ ${product.codigo}\n`;
                            message += `   üìã ${product.nome}\n`;
                            message += `   üè∑Ô∏è Lote: ${lotInput.value}\n`;
                            message += `   üî¢ Qtd: ${qtySelect.value || '1'}\n`;
                        }
                    });
                } else {
                    message += '‚ö†Ô∏è NENHUM MATERIAL SELECIONADO\n';
                }
                
                const diversos = document.getElementById('materiaisDiversos').value;
                if (diversos) {
                    message += '\n===============================\n';
                    message += '‚ûï MATERIAIS DIVERSOS:\n';
                    message += diversos + '\n';
                }
                
                // Generate PDF
                try {
                    const pdf = generatePDF();
                    const pdfBlob = pdf.output('blob');
                    const pdfUrl = URL.createObjectURL(pdfBlob);
                    
                    const link = document.createElement('a');
                    link.href = pdfUrl;
                    link.download = `Hexagon_${new Date().toISOString().slice(0,10)}.pdf`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    message += '\nüìÑ PDF salvo no dispositivo';
                    
                } catch (pdfError) {
                    console.error('Erro PDF:', pdfError);
                    message += '\n‚ö†Ô∏è Erro ao gerar PDF';
                }
                
                message += `\n\n‚è∞ ${new Date().toLocaleString('pt-BR')}`;
                message += '\nüî• Hexagon Firebase Inline v3.0';
                
                // WhatsApp
                const whatsappUrl = `https://wa.me/5519998935452?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
                
                showCompletionScreen();
                
            } catch (error) {
                console.error('Erro ao enviar:', error);
                alert('‚ùå Erro ao enviar relat√≥rio');
            }
        }

        // Show completion screen
        function showCompletionScreen() {
            document.querySelector('.main-content').classList.add('hide');
            document.querySelector('.completion-screen').classList.add('show');
        }

        // Start new report
        function startNewReport() {
            document.getElementById('otherInfo').value = '';
            document.getElementById('materiaisDiversos').value = '';
            document.getElementById('documentType').value = '';
            document.getElementById('productsContainer').innerHTML = 
                '<div class="text-center p-8 text-gray-600">‚òùÔ∏è Selecione um subgrupo</div>';
            
            document.querySelector('.main-content').classList.remove('hide');
            document.querySelector('.completion-screen').classList.remove('show');
        }
    </script>
</body>
</html>
